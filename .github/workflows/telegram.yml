name: Telegram Commit Notifier

on:
  push:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Send Telegram
        env:
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
        run: |
          [ -z "$BOT_TOKEN" ] && exit 0

          # Get the range of commits in this push
          if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.event.after }}"
            COMMITS=$(git rev-list --reverse ${BEFORE}..${AFTER})
            COMMIT_COUNT=$(echo "$COMMITS" | wc -l)
          else
            # First push or single commit
            AFTER="${{ github.event.after }}"
            COMMITS=$(git rev-list --reverse ${AFTER} -1)
            COMMIT_COUNT=1
          fi

          # Send notification for each commit
          echo "$COMMITS" | while read SHA; do
            if [ -z "$SHA" ]; then
              continue
            fi

            MSG=$(git log -1 --format=%s ${SHA} | head -c 150 | sed 's/[<>&"]/./g')
            SHA_SHORT="${SHA:0:7}"

            # Get files changed in this commit
            FILES=$(git diff-tree --no-commit-id --name-status -r ${SHA} | head -8 | while IFS=$'\t' read s f r; do
              case "$s" in A*) echo "+ $f";; M*) echo "~ $f";; D*) echo "- $f";; R*) echo "‚Üí $f ‚Üí $r";; *) echo "  $f";; esac
            done || echo "")

            STAT=$(git diff-tree --no-commit-id --shortstat ${SHA} 2>/dev/null || echo "")
            FC=$(echo "$STAT" | grep -oP '\d+(?= file)' || echo "0")
            ADD=$(echo "$STAT" | grep -oP '\d+(?= insertion)' || echo "0")
            DEL=$(echo "$STAT" | grep -oP '\d+(?= deletion)' || echo "0")

            echo "" > /tmp/t.txt
            echo "üì¶ <b>${GITHUB_REPOSITORY}</b> ‚Üí <code>${GITHUB_REF_NAME}</code>" >> /tmp/t.txt
            echo "" >> /tmp/t.txt
            echo "üë§ ${GITHUB_ACTOR} ‚Ä¢ <code>${SHA_SHORT}</code>" >> /tmp/t.txt
            echo "üí¨ ${MSG}" >> /tmp/t.txt
            echo "" >> /tmp/t.txt
            echo "üìä <code>${FC:-0}</code> files  ‚úÖ <code>+${ADD:-0}</code>  ‚ùå <code>-${DEL:-0}</code>" >> /tmp/t.txt
            echo "" >> /tmp/t.txt
            if [ -n "$FILES" ]; then
              echo "<pre>${FILES}</pre>" >> /tmp/t.txt
            fi

            TEXT=$(cat /tmp/t.txt)
            URL="https://github.com/${GITHUB_REPOSITORY}/commit/${SHA}"
            DIFF="https://github.com/${GITHUB_REPOSITORY}/compare/${BEFORE:-${SHA}^}...${SHA}"

            KEYBOARD="{\"inline_keyboard\":[[{\"text\":\"üìÑ View Commit\",\"url\":\"${URL}\"},{\"text\":\"üìä Compare\",\"url\":\"${DIFF}\"}]]}"

            curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d "chat_id=-1003345117759" \
              -d "message_thread_id=59" \
              -d "parse_mode=HTML" \
              -d "disable_web_page_preview=true" \
              --data-urlencode "text=${TEXT}" \
              --data-urlencode "reply_markup=${KEYBOARD}"

            # Small delay between messages to avoid rate limiting
            sleep 0.5
          done
